# Install SAMBA package:
apt-get install samba

cp /etc/samba/smb.conf /etc/samba/smb.conf.dist


# sample Samba config: adapt it to your needs.


cat <<END > /etc/samba/smb.conf
[global]
# Bind on IPv4 only
bind interfaces only = yes
interfaces = lo eth0
# Disable printing support completely
load printers = no
printing = bsd
printcap name = /dev/null
disable spoolss = yes
# SMB settings
workgroup = WORKGROUP
server string = %h
wins support = no
dns proxy = no
domain master = no
dns proxy = no
# Performance settings
socket options = TCP_NODELAY SO_RCVBUF=131072 SO_SNDBUF=131072
use sendfile = yes
use mmap = yes
# System settings
log file = /var/log/samba/log.%m
max log size = 1000
syslog only = no
syslog = 0
panic action = /usr/share/samba/panic-action %d
security = share
hosts allow = 192.168.0.0/24


[data-d1]
   path=/mnt/data-d1/share
   comment = Data-D1
   browseable = yes
   read only = no
   guest ok = yes
   create mode = 0666
   directory mask = 0777
   force user = root
   force group = root

[data-d2]
   path=/mnt/data-d2/share
   comment = Data-D2
   browseable = yes
   read only = no
   guest ok = yes
   create mode = 0666
   directory mask = 0777
   force user = root
   force group = root

[cmd-template]
   path=/etc/samba/commands
   browseable = no
   read only = yes
   guest ok = yes

[cmd-smb-resetcmdsessions]
   copy = cmd-template
   browseable = yes
   root postexec = /etc/samba/commands/cmd-smb-resetcmdsessions

[cmd-audio-stop]
   copy = cmd-template
   browseable = yes
   root preexec = /etc/samba/commands/cmd-audio-stop

[cmd-audio-start]
   copy = cmd-template
   browseable = yes
   root preexec = /etc/samba/commands/cmd-audio-start

[cmd-audio-test]
   copy = cmd-template
   browseable = yes
   root preexec = /etc/samba/commands/cmd-audio-test
END



# These are my local pre-exec command files, to start/stop mediacenter (which is ram-hungry) :D

mkdir /etc/samba/commands

cat <<END > /etc/samba/commands/cmd-smb-resetcmdsessions
#!/bin/sh
smbpids=\`pgrep smbd\`
for smbpid in \$smbpids; do
   smbcontrol \$smbpid close-share cmd-smb-resetcmdsessions >/dev/nul 2>&1
done
END


cat <<END > /etc/samba/commands/cmd-audio-stop
#!/bin/sh
service squeezelite stop
service logitechmediaserver stop
service pulseaudio-root stop
service bluetooth stop
service dbus stop
END


cat <<END > /etc/samba/commands/cmd-audio-start
#!/bin/sh
service dbus start
sleep 2
service bluetooth start
sleep 5
service pulseaudio-root start
sleep 2
service logitechmediaserver start
sleep 20
service squeezelite start
END


cat <<END > /etc/samba/commands/cmd-audio-test
speaker-test -t wav -c 2 -l 1
END
